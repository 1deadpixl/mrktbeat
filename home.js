var data = '[{"market_id": "1", "market": "Finance", "amount": "1.0000", "time_since_last": "2"},{"market_id": "2", "market": "Internet", "amount": "0.7451", "time_since_last": "2"},{"market_id": "3", "market": "Health and Wellness", "amount": "0.6054", "time_since_last": "1"},{"market_id": "4", "market": "Communities", "amount": "0.3492", "time_since_last": "4"},{"market_id": "5", "market": "Oil and Gas", "amount": "0.3489", "time_since_last": "4"},{"market_id": "6", "market": "Technology", "amount": "0.2794", "time_since_last": "2"},{"market_id": "7", "market": "Transportation", "amount": "0.2794", "time_since_last": "2"},{"market_id": "8", "market": "Content Creators", "amount": "0.2328", "time_since_last": "3"},{"market_id": "9", "market": "E-Commerce", "amount": "0.2328", "time_since_last": "1"},{"market_id": "10", "market": "Online Shopping", "amount": "0.2328", "time_since_last": "3"},{"market_id": "11", "market": "Wireless", "amount": "0.2328", "time_since_last": "3"},{"market_id": "12", "market": "Advertising", "amount": "0.2212", "time_since_last": "2"},{"market_id": "13", "market": "Analytics", "amount": "0.2095", "time_since_last": "2"},{"market_id": "14", "market": "Education", "amount": "0.1746", "time_since_last": "2"},{"market_id": "15", "market": "Food Processing", "amount": "0.1746", "time_since_last": "2"},{"market_id": "16", "market": "Software", "amount": "0.1746", "time_since_last": "2"},{"market_id": "17", "market": "Health Care", "amount": "0.1630", "time_since_last": "1"},{"market_id": "18", "market": "Telecommunications", "amount": "0.1467", "time_since_last": "3"},{"market_id": "19", "market": "Clean Technology", "amount": "0.1455", "time_since_last": "1"},{"market_id": "20", "market": "Curated Web", "amount": "0.1364", "time_since_last": "2"},{"market_id": "21", "market": "Hotels", "amount": "0.1315", "time_since_last": "4"},{"market_id": "22", "market": "Security", "amount": "0.1315", "time_since_last": "2"},{"market_id": "23", "market": "Design", "amount": "0.1257", "time_since_last": "2"},{"market_id": "24", "market": "Manufacturing", "amount": "0.1246", "time_since_last": "2"},{"market_id": "25", "market": "Music", "amount": "0.1234", "time_since_last": "2"},{"market_id": "26", "market": "Automotive", "amount": "0.1232", "time_since_last": "2"},{"market_id": "27", "market": "Hardware", "amount": "0.1164", "time_since_last": "4"},{"market_id": "28", "market": "Oil & Gas", "amount": "0.1164", "time_since_last": "2"},{"market_id": "29", "market": "Storage", "amount": "0.1164", "time_since_last": "4"},{"market_id": "30", "market": "Travel", "amount": "0.1106", "time_since_last": "2"},{"market_id": "31", "market": "Search", "amount": "0.1043", "time_since_last": "2"},{"market_id": "32", "market": "Photography", "amount": "0.0978", "time_since_last": "3"},{"market_id": "33", "market": "Enterprise Software", "amount": "0.0955", "time_since_last": "1"},{"market_id": "34", "market": "Games", "amount": "0.0931", "time_since_last": "2"},{"market_id": "35", "market": "Solar", "amount": "0.0931", "time_since_last": "4"},{"market_id": "36", "market": "Fashion", "amount": "0.0848", "time_since_last": "2"},{"market_id": "37", "market": "Home Automation", "amount": "0.0848", "time_since_last": "2"},{"market_id": "38", "market": "Hospitality", "amount": "0.0815", "time_since_last": "2"},{"market_id": "39", "market": "Publishing", "amount": "0.0815", "time_since_last": "2"},{"market_id": "40", "market": "Biotechnology", "amount": "0.0743", "time_since_last": "1"},{"market_id": "41", "market": "Web Tools", "amount": "0.0722", "time_since_last": "8"},{"market_id": "42", "market": "Mobile", "amount": "0.0698", "time_since_last": "1"},{"market_id": "43", "market": "Public Relations", "amount": "0.0682", "time_since_last": "2"},{"market_id": "44", "market": "Construction", "amount": "0.0652", "time_since_last": "2"},{"market_id": "45", "market": "Messaging", "amount": "0.0652", "time_since_last": "3"},{"market_id": "46", "market": "Semiconductors", "amount": "0.0605", "time_since_last": "2"},{"market_id": "47", "market": "Entertainment", "amount": "0.0582", "time_since_last": "2"},{"market_id": "48", "market": "News", "amount": "0.0582", "time_since_last": "2"},{"market_id": "49", "market": "Video Streaming", "amount": "0.0582", "time_since_last": "2"},{"market_id": "50", "market": "Batteries", "amount": "0.0580", "time_since_last": "4"},{"market_id": "51", "market": "Hardware + Software", "amount": "0.0554", "time_since_last": "2"},{"market_id": "52", "market": "Real Estate", "amount": "0.0468", "time_since_last": "2"},{"market_id": "53", "market": "Big Data", "amount": "0.0466", "time_since_last": "2"},{"market_id": "54", "market": "Mobile Payments", "amount": "0.0466", "time_since_last": "2"},{"market_id": "55", "market": "Shoes", "amount": "0.0466", "time_since_last": "5"},{"market_id": "56", "market": "Social Media", "amount": "0.0466", "time_since_last": "2"},{"market_id": "57", "market": "Web Hosting", "amount": "0.0466", "time_since_last": "2"},{"market_id": "58", "market": "Chemicals", "amount": "0.0463", "time_since_last": "6"},{"market_id": "59", "market": "Web CMS", "amount": "0.0373", "time_since_last": "3"},{"market_id": "60", "market": "Payments", "amount": "0.0361", "time_since_last": "2"},{"market_id": "61", "market": "Cloud Computing", "amount": "0.0349", "time_since_last": "2"},{"market_id": "62", "market": "Diabetes", "amount": "0.0349", "time_since_last": "3"},{"market_id": "63", "market": "File Sharing", "amount": "0.0349", "time_since_last": "4"},{"market_id": "64", "market": "Shopping", "amount": "0.0321", "time_since_last": "4"},{"market_id": "65", "market": "Big Data Analytics", "amount": "0.0319", "time_since_last": "2"},{"market_id": "66", "market": "Event Management", "amount": "0.0317", "time_since_last": "6"},{"market_id": "67", "market": "Cloud Data Services", "amount": "0.0314", "time_since_last": "2"},{"market_id": "68", "market": "Consumer Electronics", "amount": "0.0314", "time_since_last": "2"},{"market_id": "69", "market": "Credit", "amount": "0.0303", "time_since_last": "2"},{"market_id": "70", "market": "Recreation", "amount": "0.0300", "time_since_last": "10"},{"market_id": "71", "market": "Medical Professionals", "amount": "0.0298", "time_since_last": "1"},{"market_id": "72", "market": "Web Development", "amount": "0.0291", "time_since_last": "3"},{"market_id": "73", "market": "Retail", "amount": "0.0279", "time_since_last": "2"},{"market_id": "74", "market": "Risk Management", "amount": "0.0273", "time_since_last": "3"},{"market_id": "75", "market": "Home & Garden", "amount": "0.0261", "time_since_last": "2"},{"market_id": "76", "market": "Oil", "amount": "0.0256", "time_since_last": "1"},{"market_id": "77", "market": "Sports", "amount": "0.0253", "time_since_last": "2"},{"market_id": "78", "market": "Smart Grid", "amount": "0.0247", "time_since_last": "4"},{"market_id": "79", "market": "Bio-Pharm", "amount": "0.0244", "time_since_last": "7"},{"market_id": "80", "market": "Cloud-Based Music", "amount": "0.0242", "time_since_last": "3"},{"market_id": "81", "market": "Customer Service", "amount": "0.0240", "time_since_last": "3"},{"market_id": "82", "market": "Business Services", "amount": "0.0233", "time_since_last": "3"},{"market_id": "83", "market": "Communications Hardware", "amount": "0.0233", "time_since_last": "1"},{"market_id": "84", "market": "Consulting", "amount": "0.0233", "time_since_last": "2"},{"market_id": "85", "market": "English-Speaking", "amount": "0.0233", "time_since_last": "10"},{"market_id": "86", "market": "Lead Management", "amount": "0.0233", "time_since_last": "7"},{"market_id": "87", "market": "Medical Devices", "amount": "0.0233", "time_since_last": "2"},{"market_id": "88", "market": "Public Transportation", "amount": "0.0233", "time_since_last": "3"},{"market_id": "89", "market": "SaaS", "amount": "0.0233", "time_since_last": "2"},{"market_id": "90", "market": "Semantic Search", "amount": "0.0233", "time_since_last": "2"},{"market_id": "91", "market": "Tablets", "amount": "0.0233", "time_since_last": "6"},{"market_id": "92", "market": "Content Delivery", "amount": "0.0225", "time_since_last": "3"},{"market_id": "93", "market": "Data Security", "amount": "0.0221", "time_since_last": "5"},{"market_id": "94", "market": "Fleet Management", "amount": "0.0217", "time_since_last": "2"},{"market_id": "95", "market": "Financial Services", "amount": "0.0205", "time_since_last": "2"},{"market_id": "96", "market": "Email Marketing", "amount": "0.0203", "time_since_last": "2"},{"market_id": "97", "market": "Opinions", "amount": "0.0198", "time_since_last": "7"},{"market_id": "98", "market": "B2B Express Delivery", "amount": "0.0186", "time_since_last": "7"},{"market_id": "99", "market": "Credit Cards", "amount": "0.0186", "time_since_last": "3"},{"market_id": "100", "market": "Environmental Innovation", "amount": "0.0186", "time_since_last": "2"},{"market_id": "101", "market": "Group Buying", "amount": "0.0186", "time_since_last": "6"},{"market_id": "102", "market": "Insurance", "amount": "0.0186", "time_since_last": "4"},{"market_id": "103", "market": "Peer-to-Peer", "amount": "0.0186", "time_since_last": "5"},{"market_id": "104", "market": "Clean Energy", "amount": "0.0177", "time_since_last": "4"},{"market_id": "105", "market": "Energy Efficiency", "amount": "0.0175", "time_since_last": "6"},{"market_id": "106", "market": "Farming", "amount": "0.0175", "time_since_last": "2"},{"market_id": "107", "market": "Financial Exchanges", "amount": "0.0175", "time_since_last": "3"},{"market_id": "108", "market": "Virtualization", "amount": "0.0175", "time_since_last": "5"},{"market_id": "109", "market": "Energy", "amount": "0.0171", "time_since_last": "2"},{"market_id": "110", "market": "Aerospace", "amount": "0.0163", "time_since_last": "4"},{"market_id": "111", "market": "Dental", "amount": "0.0163", "time_since_last": "7"},{"market_id": "112", "market": "Fantasy Sports", "amount": "0.0163", "time_since_last": "3"},{"market_id": "113", "market": "Marketing Automation", "amount": "0.0163", "time_since_last": "2"},{"market_id": "114", "market": "Navigation", "amount": "0.0163", "time_since_last": "3"},{"market_id": "115", "market": "Networking", "amount": "0.0163", "time_since_last": "2"},{"market_id": "116", "market": "Personal Finance", "amount": "0.0163", "time_since_last": "3"},{"market_id": "117", "market": "Human Resources", "amount": "0.0155", "time_since_last": "2"},{"market_id": "118", "market": "Sales and Marketing", "amount": "0.0144", "time_since_last": "4"},{"market_id": "119", "market": "Nanotechnology", "amount": "0.0141", "time_since_last": "2"},{"market_id": "120", "market": "Data Integration", "amount": "0.0140", "time_since_last": "2"},{"market_id": "121", "market": "Enterprises", "amount": "0.0140", "time_since_last": "2"},{"market_id": "122", "market": "Hospitals", "amount": "0.0140", "time_since_last": "6"},{"market_id": "123", "market": "Marketplaces", "amount": "0.0140", "time_since_last": "2"},{"market_id": "124", "market": "Tech Field Support", "amount": "0.0140", "time_since_last": "2"},{"market_id": "125", "market": "Video", "amount": "0.0140", "time_since_last": "2"},{"market_id": "126", "market": "Discounts", "amount": "0.0132", "time_since_last": "3"},{"market_id": "127", "market": "Data Centers", "amount": "0.0128", "time_since_last": "1"},{"market_id": "128", "market": "Content", "amount": "0.0126", "time_since_last": "2"},{"market_id": "129", "market": "Testing", "amount": "0.0126", "time_since_last": "3"},{"market_id": "130", "market": "Geospatial", "amount": "0.0121", "time_since_last": "7"},{"market_id": "131", "market": "Mobile Security", "amount": "0.0121", "time_since_last": "2"},{"market_id": "132", "market": "Television", "amount": "0.0119", "time_since_last": "0"},{"market_id": "133", "market": "Pharmaceuticals", "amount": "0.0118", "time_since_last": "2"},{"market_id": "134", "market": "Agriculture", "amount": "0.0116", "time_since_last": "2"},{"market_id": "135", "market": "Billing", "amount": "0.0116", "time_since_last": "6"},{"market_id": "136", "market": "Enterprise Resource Planning", "amount": "0.0116", "time_since_last": "5"},{"market_id": "137", "market": "Medical", "amount": "0.0116", "time_since_last": "3"},{"market_id": "138", "market": "Optimization", "amount": "0.0116", "time_since_last": "5"},{"market_id": "139", "market": "Therapeutics", "amount": "0.0114", "time_since_last": "10"},{"market_id": "140", "market": "Fraud Detection", "amount": "0.0105", "time_since_last": "9"},{"market_id": "141", "market": "Groceries", "amount": "0.0102", "time_since_last": "4"},{"market_id": "142", "market": "Identity", "amount": "0.0102", "time_since_last": "2"},{"market_id": "143", "market": "Databases", "amount": "0.0098", "time_since_last": "3"},{"market_id": "144", "market": "Home Decor", "amount": "0.0095", "time_since_last": "2"},{"market_id": "145", "market": "Data Center Infrastructure", "amount": "0.0093", "time_since_last": "8"},{"market_id": "146", "market": "Doctors", "amount": "0.0093", "time_since_last": "7"},{"market_id": "147", "market": "Information Security", "amount": "0.0093", "time_since_last": "4"},{"market_id": "148", "market": "Wind", "amount": "0.0091", "time_since_last": "11"},{"market_id": "149", "market": "Collaboration", "amount": "0.0087", "time_since_last": "2"},{"market_id": "150", "market": "Apps", "amount": "0.0084", "time_since_last": "2"},{"market_id": "151", "market": "Brokers", "amount": "0.0081", "time_since_last": "6"},{"market_id": "152", "market": "Specialty Chemicals", "amount": "0.0080", "time_since_last": "3"},{"market_id": "153", "market": "Diagnostics", "amount": "0.0070", "time_since_last": "7"},{"market_id": "154", "market": "Distributed Generation", "amount": "0.0070", "time_since_last": "9"},{"market_id": "155", "market": "Game Mechanics", "amount": "0.0070", "time_since_last": "8"},{"market_id": "156", "market": "Religion", "amount": "0.0070", "time_since_last": "7"},{"market_id": "157", "market": "World Domination", "amount": "0.0061", "time_since_last": "1"},{"market_id": "158", "market": "Coffee", "amount": "0.0060", "time_since_last": "3"},{"market_id": "159", "market": "Coworking", "amount": "0.0047", "time_since_last": "0"},{"market_id": "160", "market": "Lingerie", "amount": "0.0047", "time_since_last": "5"},{"market_id": "161", "market": "Rapidly Expanding", "amount": "0.0047", "time_since_last": "0"},{"market_id": "162", "market": "Call Center Automation", "amount": "0.0035", "time_since_last": "6"},{"market_id": "163", "market": "Recipes", "amount": "0.0031", "time_since_last": "0"}]';
  data = $.parseJSON(data);
  console.dir(data);

var width = 1920,
    height = 1200,
    padding = 1.5, // separation between same-color circles
    clusterPadding = 6, // separation between different-color circles
    maxRadius = 1000;

var n = data.length, // total number of circles // data.length
    m = 10; // number of distinct clusters // data .length / some number 

var color = d3.scale.category10()
    .domain(d3.range(m));

// The largest node for each cluster.
var clusters = new Array(m);

var nodes = d3.range(n).map(function(currentValue, index) {

  var i = Math.floor(Math.random() * m),
  // this sets the radius of the circles
      r = Math.sqrt((i + 1) / m * -Math.log(Math.random())) * maxRadius,
      d = {cluster: i, radius: data[index].amount * maxRadius, 
                    time_since_last: data[index].time_since_last, 
                    market_id: data[index].market_id};

  if (!clusters[i] || (r > clusters[i].radius)) clusters[i] = d;
  return d;
});

var force = d3.layout.force()
    .nodes(nodes)
    .size([width, height])
    .gravity(.02)
    .charge(0)
    .on("tick", tick)
    .start();

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var circle = svg.selectAll("circle")
    .data(nodes)
    .enter().append("circle")
    .attr("id", function(d) {return "circle_" + d.market_id;})
    .attr("r", function(d) { return d.radius; })
    .attr("class", function(d) { 
          var c = "";
          if (d.time_since_last <= 3) {c = "default red"} 
          else if (d.time_since_last> 3 && d.time_since_last <= 6) {c = "default violet"}
          else if (d.time_since_last > 6 && d.time_since_last <= 9) {c = "default mediumvioletred"}
          else if (d.time_since_last > 9 && d.time_since_last <= 12) {c = "default blue"}
          else if (d.time_since_last > 12 && d.time_since_last <= 18) {c = "default blueviolet"}
          else if (d.time_since_last > 18) {c = "indigo"}
          return c;
        })
    .call(force.drag);

function tick(e) {
  var circle = d3.selectAll("circle")
      .each(cluster(10 * e.alpha * e.alpha))
      .each(collide(.5))
      .attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; });
}

// Move d to be adjacent to the cluster node.
function cluster(alpha) {
  return function(d) {
    var cluster = clusters[d.cluster];
    if (cluster === d) return;
    var x = d.x - cluster.x,
        y = d.y - cluster.y,
        l = Math.sqrt(x * x + y * y),
        r = d.radius + cluster.radius;
    if (l != r) {
      l = (l - r) / l * alpha;
      d.x -= x *= l;
      d.y -= y *= l;
      cluster.x += x;
      cluster.y += y;
    }
  };
}

// Resolves collisions between d and all other circles.
function collide(alpha) {
  var quadtree = d3.geom.quadtree(nodes);
  return function(d) {
    var r = d.radius + maxRadius + Math.max(padding, clusterPadding),
        nx1 = d.x - r,
        nx2 = d.x + r,
        ny1 = d.y - r,
        ny2 = d.y + r;
    quadtree.visit(function(quad, x1, y1, x2, y2) {
      if (quad.point && (quad.point !== d)) {
        var x = d.x - quad.point.x,
            y = d.y - quad.point.y,
            l = Math.sqrt(x * x + y * y),
            r = d.radius + quad.point.radius + (d.cluster === quad.point.cluster ? padding : clusterPadding);
        if (l < r) {
          l = (l - r) / l * alpha;
          d.x -= x *= l;
          d.y -= y *= l;
          quad.point.x += x;
          quad.point.y += y;
        }
      }
      return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
    });
  };
}

});

function removeCircleColorClass(token) {
    d3.select("#circle_" + token.id).classed("default",false);
}

function addCircleColorClass(token) {
    d3.select("#circle_" + token.id).classed("default",true);
}